# Netlify configuration for ui.a11ypros.com

[build]
  # Base directory for the build
  base = "."
  # Install dependencies, build Storybook, then build Next.js app
  # Note: Move API route temporarily since static export can't handle it (we use Netlify Functions)
  command = "mv apps/web/app/api apps/web/app/api.disabled 2>/dev/null || true && yarn install && yarn build-storybook && yarn workspace @apps/web build && test -d apps/web/out && echo 'Build successful' || (echo 'Build failed' && exit 1) && mv apps/web/app/api.disabled apps/web/app/api 2>/dev/null || true"
  # Publish directory - Next.js static export (includes Storybook in public/)
  publish = "apps/web/out"

# Environment variables (set these in Netlify dashboard)
# [build.environment]
#   NODE_VERSION = "18"
#   ANTHROPIC_API_KEY = "your_key_here"

# Redirect rules are now in apps/web/public/_redirects
# The _redirects file takes precedence and is included in the build output
# This keeps redirects in sync with the built files

# Headers for Storybook - VERY permissive CSP to allow eval
# netlify.toml headers work with netlify serve, _headers file may not
# Storybook requires 'unsafe-eval' in script-src - this is the most permissive CSP that works
[[headers]]
  for = "/storybook-static/*"
  [headers.values]
    Content-Security-Policy = "default-src 'self' 'unsafe-inline' data: blob: http: https: ws: wss:; script-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: http: https:; style-src 'self' 'unsafe-inline' data: http: https:; img-src 'self' data: blob: http: https:; font-src 'self' data: http: https:; connect-src 'self' ws: wss: blob: http: https:; worker-src 'self' blob: http: https:; frame-src 'self' http: https:; frame-ancestors 'self';"

[[headers]]
  for = "/storybook"
  [headers.values]
    Content-Security-Policy = "default-src 'self' 'unsafe-inline' data: blob: http: https: ws: wss:; script-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: http: https:; style-src 'self' 'unsafe-inline' data: http: https:; img-src 'self' data: blob: http: https:; font-src 'self' data: http: https:; connect-src 'self' ws: wss: blob: http: https:; worker-src 'self' blob: http: https:; frame-src 'self' http: https:; frame-ancestors 'self';"

[[headers]]
  for = "/storybook/*"
  [headers.values]
    Content-Security-Policy = "default-src 'self' 'unsafe-inline' data: blob: http: https: ws: wss:; script-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: http: https:; style-src 'self' 'unsafe-inline' data: http: https:; img-src 'self' data: blob: http: https:; font-src 'self' data: http: https:; connect-src 'self' ws: wss: blob: http: https:; worker-src 'self' blob: http: https:; frame-src 'self' http: https:; frame-ancestors 'self';"
