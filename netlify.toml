# Netlify configuration for ui.a11ypros.com

[build]
  # Base directory for the build
  base = "."
  # Install dependencies, build Storybook, then build Next.js app
  # Note: Move API route temporarily since static export can't handle it (we use Netlify Functions)
  command = "mv apps/web/app/api apps/web/app/api.disabled 2>/dev/null || true && yarn install && yarn build-storybook && yarn workspace @apps/web build && test -d apps/web/out && echo 'Build successful' || (echo 'Build failed' && exit 1) && mv apps/web/app/api.disabled apps/web/app/api 2>/dev/null || true"
  # Publish directory - Next.js static export (includes Storybook in public/)
  publish = "apps/web/out"

# Environment variables (set these in Netlify dashboard)
# [build.environment]
#   NODE_VERSION = "18"
#   ANTHROPIC_API_KEY = "your_key_here"

# Redirect rules - serve Storybook at /storybook
# These must come BEFORE the catch-all redirect
# First, handle the root /storybook path
[[redirects]]
  from = "/storybook"
  to = "/storybook-static/index.html"
  status = 200
  force = true

# Handle all Storybook sub-paths (JS files, assets, etc.)
# This catches /storybook/sb-manager/runtime.js â†’ /storybook-static/sb-manager/runtime.js
[[redirects]]
  from = "/storybook/*"
  to = "/storybook-static/:splat"
  status = 200
  force = true

# Netlify Function for audit API
[[redirects]]
  from = "/api/audit"
  to = "/.netlify/functions/audit"
  status = 200

# Explicitly serve Storybook static files (JS, CSS, etc.)
# This must come before the catch-all to prevent JS files from being redirected to /index.html
[[redirects]]
  from = "/storybook-static/*"
  to = "/storybook-static/:splat"
  status = 200
  force = true

# Next.js SPA fallback for client-side routing (must be last)
# Note: /storybook* and /storybook-static* are handled by rules above
[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200
